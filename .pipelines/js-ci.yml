name: $(date:yyMM).$(date:dd)$(rev:rrr)

pr:
  branches:
    include:
    - main
  paths:
    include:
    - source/nodejs

pool:
  name: Azure Pipelines
  vmImage: ubuntu-20.04
  demands:
  - npm

parameters:
- name: target_packages
  displayName: "Which packages is going to be built."
  type: object
  default:
  - adaptivecards
  - adaptivecards-controls
  - adaptivecards-designer
  - adaptivecards-templating
  - adaptivecards-react

steps:
- task: NodeTool@0
  name: NodeTool1
  displayName: Use Node 14.x
  inputs:
    versionSpec: 14.x

- task: CopyFiles@2
  inputs:
    sourceFolder: source/nodejs/adaptivecards-react-testapp
    contents: '**' 
    targetFolder: source/adaptivecards-react-testapp

- bash: |
   npm ci 
   npx lerna bootstrap --ci
   npx lerna run release
  workingDirectory: source/nodejs
  displayName: 'Bash - lerna bootstrap'

- ${{ each target_package in parameters.target_packages }}:
  - task: Npm@1
    displayName: '[${{ target_package }}] npm pack'
    inputs:
      command: custom
      customCommand: pack
      workingDir: source/nodejs/${{ target_package }}
  
  - task: CopyFiles@2
    inputs:
      sourceFolder: source/nodejs/${{ target_package }}
      contents: '*.tgz' 
      targetFolder: source/adaptivecards-react-testapp


- bash: |
    npm i *.tgz
    cat package.json
    npm run build
  workingDirectory: source/adaptivecards-react-testapp
  displayName: 'Install the built package and build the project'

